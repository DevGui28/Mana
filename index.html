<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guarda-Roupa Solidário v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
        }
        /* Custom scrollbar for chat and lists */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-4xl mx-auto p-4 min-h-screen">
        <!-- O conteúdo da aplicação será renderizado aqui -->
    </div>
    
    <!-- Toast de notificação -->
    <div id="toast" class="hidden fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 transition-transform transform translate-y-16 duration-300">
        <p id="toast-message"></p>
    </div>

    <!-- Templates das Views (Login não muda) -->
    <template id="login-view-template">
        <div class="flex flex-col items-center justify-center min-h-screen">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-indigo-500 mb-4"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9.5 9 2 2 4-4"></path></svg>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Guarda-Roupa Solidário</h1>
                <p class="text-gray-600 mb-8">Conectando doadores e quem precisa. Dê uma segunda vida às suas roupas.</p>
                <div id="auth-form-container"></div>
                <div id="auth-buttons">
                    <button id="show-login-btn" class="w-full bg-indigo-500 text-white font-semibold py-3 rounded-lg hover:bg-indigo-600 transition-all duration-300 mb-4 shadow-sm">Entrar</button>
                    <button id="show-register-btn" class="w-full bg-gray-200 text-gray-700 font-semibold py-3 rounded-lg hover:bg-gray-300 transition-all duration-300">Criar Conta</button>
                </div>
            </div>
        </div>
    </template>
    
    <template id="auth-form-template">
         <form id="auth-form" class="space-y-4 mb-4">
            <h2 class="text-2xl font-semibold text-gray-700" id="form-title"></h2>
            <input type="text" id="name" placeholder="Nome Completo" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition" required>
            <input type="email" id="email" placeholder="E-mail" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition" required>
            <input type="password" id="password" placeholder="Senha" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition" required>
            <div id="user-type-container" class="text-left">
                <label class="block text-gray-600 mb-2 font-medium">Qual o seu objetivo?</label>
                <div class="flex gap-4">
                    <label class="flex-1"><input type="radio" name="userType" value="donor" class="sr-only peer" checked><div class="p-3 border-2 border-gray-300 rounded-lg cursor-pointer peer-checked:border-indigo-500 peer-checked:bg-indigo-50 peer-checked:text-indigo-600"><span class="font-semibold">Quero Doar</span></div></label>
                    <label class="flex-1"><input type="radio" name="userType" value="recipient" class="sr-only peer"><div class="p-3 border-2 border-gray-300 rounded-lg cursor-pointer peer-checked:border-indigo-500 peer-checked:bg-indigo-50 peer-checked:text-indigo-600"><span class="font-semibold">Receber Doação</span></div></label>
                </div>
            </div>
            <p id="auth-error" class="text-red-500 text-sm hidden"></p>
            <button type="submit" id="auth-submit-btn" class="w-full bg-indigo-500 text-white font-semibold py-3 rounded-lg hover:bg-indigo-600 transition-all duration-300 shadow-sm"></button>
            <button type="button" id="back-to-auth-selection" class="w-full mt-2 text-gray-600 hover:text-indigo-500 font-medium">Voltar</button>
        </form>
    </template>
    
    <!-- Templates dos Dashboards Atualizados -->
    <template id="donor-dashboard-template">
        <div class="w-full">
            <header class="flex justify-between items-center mb-8 pb-4 border-b">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Minhas Doações</h1>
                    <p class="text-gray-600">Olá, <span id="user-name"></span>! Gerencie as roupas que você doou.</p>
                </div>
                 <div class="flex items-center gap-4">
                     <button id="add-item-btn" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 transition-all duration-300 shadow-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Adicionar Peça
                     </button>
                    <div class="relative">
                        <button id="notifications-btn" class="text-gray-500 hover:text-indigo-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg></button>
                        <span id="notifications-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs w-4 h-4 rounded-full flex items-center justify-center"></span>
                    </div>
                    <button id="logout-btn" class="text-gray-500 hover:text-red-500 font-medium">Sair</button>
                </div>
            </header>
            <div id="donations-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <p id="no-donations-message" class="text-center text-gray-500 mt-10 hidden">Você ainda não adicionou nenhuma peça para doação.</p>
        </div>
    </template>
    
    <template id="recipient-dashboard-template">
        <div class="w-full">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 pb-4 border-b">
                <div class="mb-4 md:mb-0">
                    <h1 class="text-3xl font-bold text-gray-800">Peças Disponíveis</h1>
                    <p class="text-gray-600">Olá, <span id="user-name"></span>! Encontre uma peça para você.</p>
                </div>
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <button id="my-requests-btn" class="bg-white border border-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-50 transition-all duration-300 flex-1 md:flex-auto">Meus Pedidos</button>
                    <div class="relative">
                        <button id="notifications-btn" class="text-gray-500 hover:text-indigo-500"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg></button>
                        <span id="notifications-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs w-4 h-4 rounded-full flex items-center justify-center"></span>
                    </div>
                    <button id="logout-btn" class="text-gray-500 hover:text-red-500 font-medium">Sair</button>
                </div>
            </header>
            <div class="flex flex-col sm:flex-row gap-4 mb-6 p-4 bg-white rounded-lg shadow-sm">
                <select id="filter-category" class="w-full sm:w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none"><option value="">Todas as Categorias</option><option value="camisetas">Camisetas</option><option value="calcas">Calças</option><option value="vestidos">Vestidos</option><option value="casacos">Casacos</option><option value="calcados">Calçados</option><option value="outros">Outros</option></select>
                <select id="filter-size" class="w-full sm:w-1/2 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none"><option value="">Todos os Tamanhos</option><option value="PP">PP</option><option value="P">P</option><option value="M">M</option><option value="G">G</option><option value="GG">GG</option><option value="XG">XG</option></select>
            </div>
            <div id="items-gallery" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            <p id="no-items-message" class="text-center text-gray-500 mt-10 hidden">Nenhuma peça disponível no momento. Volte mais tarde!</p>
        </div>
    </template>
    
    <!-- Modals -->
    <div id="add-item-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-8 relative">
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Adicionar Nova Peça</h2>
            <form id="add-item-form" class="space-y-4">
                 <input type="text" id="item-title" placeholder="Título da Peça (ex: Camisa de Algodão Azul)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition" required>
                 <div class="relative"><textarea id="item-description" placeholder="Descrição (cor, marca, detalhes...)" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition" required></textarea><button type="button" id="generate-ai-description" class="absolute bottom-3 right-3 bg-indigo-100 text-indigo-600 text-xs font-semibold py-1 px-2 rounded-md hover:bg-indigo-200 transition-all">✨ Gerar com IA</button></div>
                 
                 <div>
                    <label for="item-image-upload" class="block text-sm font-medium text-gray-700 mb-2">Foto da Peça</label>
                    <input type="file" id="item-image-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" required>
                    <div id="upload-progress-container" class="w-full bg-gray-200 rounded-full h-2.5 mt-2 hidden"><div id="upload-progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div></div>
                 </div>

                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <select id="item-category" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" required><option value="" disabled selected>Categoria</option><option value="camisetas">Camisetas</option><option value="calcas">Calças</option><option value="vestidos">Vestidos</option><option value="casacos">Casacos</option><option value="calcados">Calçados</option><option value="outros">Outros</option></select>
                    <select id="item-size" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" required><option value="" disabled selected>Tamanho</option><option value="PP">PP</option><option value="P">P</option><option value="M">M</option><option value="G">G</option><option value="GG">GG</option><option value="XG">XG</option></select>
                </div>
                 <select id="item-condition" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" required><option value="" disabled selected>Condição da Peça</option><option value="novo">Nova (com etiqueta)</option><option value="pouco_usado">Pouco usada</option><option value="usado">Usada</option></select>
                <button type="submit" id="add-item-submit-btn" class="w-full bg-indigo-500 text-white font-semibold py-3 rounded-lg hover:bg-indigo-600 transition-all duration-300 shadow-sm">Adicionar Peça</button>
            </form>
        </div>
    </div>
    
    <div id="my-requests-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
         <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl p-8 relative">
            <button id="close-requests-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Meus Pedidos de Doação</h2>
            <div id="my-requests-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar"></div>
            <p id="no-requests-message" class="text-center text-gray-500 mt-6 hidden">Você ainda não demonstrou interesse em nenhuma peça.</p>
        </div>
    </div>
    
    <div id="notifications-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
         <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-8 relative">
            <button id="close-notifications-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Minhas Notificações</h2>
            <div id="notifications-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar"></div>
            <p id="no-notifications-message" class="text-center text-gray-500 mt-6 hidden">Você não tem nenhuma notificação.</p>
        </div>
    </div>
    
    <div id="chat-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
         <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg h-[80vh] p-6 relative flex flex-col">
            <button id="close-chat-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <h2 id="chat-title" class="text-xl font-bold text-gray-800 mb-4 pb-4 border-b">Chat</h2>
            <div id="chat-messages" class="flex-1 overflow-y-auto space-y-4 p-2 custom-scrollbar"></div>
            <form id="chat-form" class="mt-4 flex gap-2">
                <input type="text" id="chat-message-input" placeholder="Digite sua mensagem..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition" required>
                <button type="submit" class="bg-indigo-500 text-white font-semibold p-3 rounded-lg hover:bg-indigo-600 transition-all shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
            </form>
        </div>
    </div>
    
    <div id="review-modal" class="hidden fixed inset-0 z-50 overflow-y-auto modal-backdrop flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8 relative">
            <button id="close-review-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            <h2 id="review-modal-title" class="text-2xl font-bold text-gray-800 mb-6">Deixar Avaliação</h2>
            <form id="review-form" class="space-y-4">
                <div class="flex justify-center text-4xl text-gray-300" id="star-rating">
                    <span data-value="1" class="cursor-pointer hover:text-yellow-400">★</span>
                    <span data-value="2" class="cursor-pointer hover:text-yellow-400">★</span>
                    <span data-value="3" class="cursor-pointer hover:text-yellow-400">★</span>
                    <span data-value="4" class="cursor-pointer hover:text-yellow-400">★</span>
                    <span data-value="5" class="cursor-pointer hover:text-yellow-400">★</span>
                </div>
                 <textarea id="review-comment" placeholder="Deixe um comentário sobre a sua experiência..." rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none transition" required></textarea>
                <button type="submit" class="w-full bg-indigo-500 text-white font-semibold py-3 rounded-lg hover:bg-indigo-600 transition-all duration-300 shadow-sm">Enviar Avaliação</button>
            </form>
        </div>
    </div>


    <script type="module">
// Importações do Firebase
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, onSnapshot, updateDoc, arrayUnion, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

// --- Configuração do Firebase ---
// IMPORTANTE: Cole aqui o seu objeto de configuração do Firebase
const firebaseConfig = {
    apiKey: "AIzaSyAe50fmpWZxwOWNPALrhsZnk1Orc6UosI",
    authDomain: "guarda-roupa-44184.firebaseapp.com",
    projectId: "guarda-roupa-44184",
    storageBucket: "guarda-roupa-44184.appspot.com",
    messagingSenderId: "734644098197",
    appId: "1:734644098197:web:5a8170abcf94d05ec6779c"
};
// const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// --- Variáveis de Estado Globais ---
let currentUser = null;
let unsubscribeListeners = [];
let currentChatUnsubscribe = null;
let currentReviewContext = {};

// --- Elementos do DOM ---
const appContainer = document.getElementById('app');
const toast = document.getElementById('toast');
const toastMessage = document.getElementById('toast-message');

// --- Funções de Utilidade ---
function showToast(message, isError = false) {
    toastMessage.textContent = message;
    toast.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'translate-y-16');
    toast.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
    setTimeout(() => {
        toast.classList.add('translate-y-16');
        setTimeout(() => toast.classList.add('hidden'), 300);
    }, 3000);
}

function renderView(viewId, data = {}) {
    clearSubscriptions();
    const template = document.getElementById(viewId).innerHTML;
    appContainer.innerHTML = template;
    if(data.userName) {
        const userNameSpans = document.querySelectorAll('#user-name');
        userNameSpans.forEach(span => span.textContent = data.userName);
    }
    
    // Apenas adiciona listeners de notificação se o usuário estiver logado
    if (currentUser) {
        const notificationBtns = document.querySelectorAll('#notifications-btn');
        notificationBtns.forEach(btn => btn.addEventListener('click', showNotificationsModal));
        listenToNotifications();
    }
}

// --- Lógica de Autenticação ---
function showLoginView() {
    renderView('login-view-template');
    document.getElementById('show-login-btn').addEventListener('click', () => renderAuthForm('login'));
    document.getElementById('show-register-btn').addEventListener('click', () => renderAuthForm('register'));
}
function renderAuthForm(type) {
     const authFormContainer = document.getElementById('auth-form-container');
     const template = document.getElementById('auth-form-template').innerHTML;
     authFormContainer.innerHTML = template;
     document.getElementById('auth-buttons').classList.add('hidden');
     const formTitle = document.getElementById('form-title'), nameField = document.getElementById('name'), userTypeContainer = document.getElementById('user-type-container'), authSubmitBtn = document.getElementById('auth-submit-btn');
     if(type === 'login') {
        formTitle.textContent = 'Acessar minha conta';
        nameField.classList.add('hidden'); nameField.required = false;
        userTypeContainer.classList.add('hidden');
        authSubmitBtn.textContent = 'Entrar';
     } else {
         formTitle.textContent = 'Criar nova conta';
         nameField.classList.remove('hidden'); nameField.required = true;
         userTypeContainer.classList.remove('hidden');
         authSubmitBtn.textContent = 'Cadastrar';
     }
     document.getElementById('auth-form').addEventListener('submit', handleAuthFormSubmit);
     document.getElementById('back-to-auth-selection').addEventListener('click', () => {
         document.getElementById('auth-buttons').classList.remove('hidden'); authFormContainer.innerHTML = '';
     });
}
async function handleAuthFormSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const email = form.email.value, password = form.password.value, name = form.name.value, userType = form.userType ? form.userType.value : null;
    const errorEl = document.getElementById('auth-error');
    errorEl.classList.add('hidden');
    try {
        if (userType) { // Cadastro
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await setDoc(doc(db, "users", userCredential.user.uid), {
                name: name, email: email, userType: userType, avgRating: 0, numRatings: 0
            });
        } else { await signInWithEmailAndPassword(auth, email, password); }
    } catch (error) {
         console.error("Erro de autenticação:", error);
         errorEl.textContent = "E-mail ou senha inválidos. Tente novamente.";
         errorEl.classList.remove('hidden');
    }
}

// --- Gerenciador de Views ---
async function showDashboard(user) {
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (!userDoc.exists()) { console.error("Documento de usuário não encontrado!"); return; }
    currentUser = { uid: user.uid, ...userDoc.data() };
    if (currentUser.userType === 'donor') showDonorDashboard();
    else showRecipientDashboard();
}

function showDonorDashboard() {
    renderView('donor-dashboard-template', { userName: currentUser.name.split(' ')[0] });
    document.getElementById('add-item-btn').addEventListener('click', () => { document.getElementById('add-item-modal').classList.remove('hidden'); });
    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
    setupAddItemModalListeners();
    listenToMyDonations();
}

function showRecipientDashboard() {
    renderView('recipient-dashboard-template', { userName: currentUser.name.split(' ')[0] });
    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
    document.getElementById('my-requests-btn').addEventListener('click', showMyRequestsModal);
    document.getElementById('filter-category').addEventListener('change', filterItems);
    document.getElementById('filter-size').addEventListener('change', filterItems);
    listenToAvailableItems();
}

// --- Lógica do Doador ---
function setupAddItemModalListeners() {
    const modal = document.getElementById('add-item-modal');
    document.getElementById('close-modal-btn').addEventListener('click', () => modal.classList.add('hidden'));
    document.getElementById('add-item-form').addEventListener('submit', handleAddItem);
    // AI description feature
    document.getElementById('generate-ai-description').addEventListener('click', async () => { 
        const title = document.getElementById('item-title').value;
        const userDescription = document.getElementById('item-description').value;
        const button = document.getElementById('generate-ai-description');
        const descriptionTextarea = document.getElementById('item-description');

        if (!title) {
            showToast("Por favor, preencha o título primeiro.", true);
            return;
        }

        button.disabled = true;
        button.textContent = "Gerando...";
        
        const prompt = `Aja como um especialista em moda para brechós. Crie uma descrição curta (2-3 frases), amigável e atrativa para uma peça de roupa para doação. Destaque os pontos positivos. Título da Peça: "${title}". Detalhes do usuário: "${userDescription}"`;
        
        try {
            const apiKey = ""; // Será preenchido pelo ambiente
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            const result = await response.json();
            const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (generatedText) {
                descriptionTextarea.value = generatedText.trim();
            } else {
                throw new Error("Não foi possível gerar a descrição.");
            }
        } catch (error) {
            console.error("Erro na API Gemini:", error);
            showToast("Não foi possível gerar a descrição.", true);
        } finally {
            button.disabled = false;
            button.textContent = "✨ Gerar com IA";
        }
    });
}

function handleAddItem(e) {
    e.preventDefault();
    const form = e.target;
    const file = form['item-image-upload'].files[0];
    if (!file) {
        showToast("Por favor, selecione uma imagem.", true);
        return;
    }

    const submitBtn = document.getElementById('add-item-submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Enviando...';

    const progressContainer = document.getElementById('upload-progress-container');
    const progressBar = document.getElementById('upload-progress-bar');
    progressContainer.classList.remove('hidden');

    const storageRef = ref(storage, `clothing_images/${currentUser.uid}/${Date.now()}_${file.name}`);
    const uploadTask = uploadBytesResumable(storageRef, file);

    uploadTask.on('state_changed', 
        (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progressBar.style.width = progress + '%';
        }, 
        (error) => {
            console.error("Erro no upload:", error);
            showToast("Falha no upload da imagem.", true);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Adicionar Peça';
            progressContainer.classList.add('hidden');
        }, 
        async () => {
            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
            const itemData = {
                donorId: currentUser.uid, donorName: currentUser.name,
                title: form['item-title'].value, description: form['item-description'].value,
                imageUrl: downloadURL, category: form['item-category'].value, size: form['item-size'].value,
                condition: form['item-condition'].value, status: 'available',
                interestedUsers: [], assignedTo: null, createdAt: serverTimestamp()
            };
            try {
                await addDoc(collection(db, "clothing_items"), itemData);
                showToast("Peça adicionada com sucesso!");
                form.reset();
                document.getElementById('add-item-modal').classList.add('hidden');
            } catch (error) {
                console.error("Erro ao salvar item:", error);
                showToast("Erro ao adicionar a peça.", true);
            } finally {
                 submitBtn.disabled = false;
                 submitBtn.textContent = 'Adicionar Peça';
                 progressContainer.classList.add('hidden');
                 progressBar.style.width = '0%';
            }
        }
    );
}

// --- Lógica de Chat ---
function openChatModal(itemId, recipientId, recipientName, itemTitle) {
    const modal = document.getElementById('chat-modal');
    modal.dataset.itemId = itemId;
    modal.dataset.recipientId = recipientId;
    document.getElementById('chat-title').textContent = `Chat sobre: ${itemTitle}`;
    modal.classList.remove('hidden');
    
    document.getElementById('close-chat-modal-btn').addEventListener('click', () => {
        modal.classList.add('hidden');
        if(currentChatUnsubscribe) currentChatUnsubscribe();
    }, { once: true });

    const chatMessagesContainer = document.getElementById('chat-messages');
    chatMessagesContainer.innerHTML = '<p class="text-center text-gray-500">Carregando mensagens...</p>';

    const messagesRef = collection(db, `chats/${itemId}/messages`);
    const q = query(messagesRef, orderBy("createdAt"));
    currentChatUnsubscribe = onSnapshot(q, (snapshot) => {
        chatMessagesContainer.innerHTML = '';
        snapshot.forEach(doc => {
            const msg = doc.data();
            const isSender = msg.senderId === currentUser.uid;
            const messageEl = document.createElement('div');
            messageEl.className = `flex flex-col ${isSender ? 'items-end' : 'items-start'}`;
            messageEl.innerHTML = `
                <div class="max-w-xs px-4 py-2 rounded-2xl ${isSender ? 'bg-indigo-500 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'}">
                    <p>${msg.text}</p>
                </div>
                <span class="text-xs text-gray-400 mt-1">${new Date(msg.createdAt?.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
            `;
            chatMessagesContainer.appendChild(messageEl);
        });
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
    });
    
    document.getElementById('chat-form').onsubmit = handleSendMessage;
}

async function handleSendMessage(e) {
    e.preventDefault();
    const modal = document.getElementById('chat-modal');
    const itemId = modal.dataset.itemId;
    const recipientId = modal.dataset.recipientId;
    const input = document.getElementById('chat-message-input');
    const text = input.value.trim();
    if (!text) return;

    input.value = '';
    
    await addDoc(collection(db, `chats/${itemId}/messages`), {
        text: text,
        senderId: currentUser.uid,
        senderName: currentUser.name,
        createdAt: serverTimestamp()
    });

    const itemDoc = await getDoc(doc(db, "clothing_items", itemId));
    const donorId = itemDoc.data().donorId;
    const otherUserId = currentUser.uid === recipientId ? donorId : recipientId;
    
    const chatTitle = document.getElementById('chat-title').textContent.split(': ')[1];
    createNotification(otherUserId, `Nova mensagem sobre: ${chatTitle}`, itemId);
}

// --- Lógica de Avaliação ---
function openReviewModal(itemId, reviewedUserId, reviewedUserName) {
    const modal = document.getElementById('review-modal');
    currentReviewContext = { itemId, reviewedUserId };
    document.getElementById('review-modal-title').textContent = `Avaliar ${reviewedUserName.split(' ')[0]}`;
    modal.classList.remove('hidden');
    
    document.getElementById('close-review-modal-btn').addEventListener('click', () => modal.classList.add('hidden'), { once: true });
    
    const stars = document.querySelectorAll('#star-rating span');
    let currentRating = 0;
    
    const setRating = (value) => {
        stars.forEach(s => s.classList.remove('text-yellow-400'));
        for (let i = 0; i < value; i++) {
            stars[i].classList.add('text-yellow-400');
        }
    };
    
    stars.forEach(star => {
        star.onmouseover = () => setRating(star.dataset.value);
        star.onclick = () => { currentRating = star.dataset.value; };
        star.onmouseleave = () => setRating(currentRating);
    });
    
    document.getElementById('review-form').onsubmit = (e) => handleReviewSubmit(e, currentRating);
}

async function handleReviewSubmit(e, rating) {
     e.preventDefault();
     if (rating == 0) {
         showToast("Por favor, selecione uma avaliação de estrelas.", true);
         return;
     }
     const { itemId, reviewedUserId } = currentReviewContext;
     const comment = document.getElementById('review-comment').value;

     await addDoc(collection(db, 'reviews'), {
         itemId, reviewedUserId, rating: parseInt(rating), comment,
         reviewerId: currentUser.uid, reviewerName: currentUser.name,
         createdAt: serverTimestamp()
     });
     
     if (currentUser.userType === 'donor') {
         await updateDoc(doc(db, 'clothing_items', itemId), { status: 'completed' });
         createNotification(reviewedUserId, `${currentUser.name} finalizou a doação e deixou uma avaliação. Deixe a sua também!`, itemId);
     }

     showToast("Avaliação enviada com sucesso!");
     document.getElementById('review-modal').classList.add('hidden');
     e.target.reset();
}

// --- Lógica de Notificações ---
async function createNotification(userId, message, relatedItemId = null) {
    await addDoc(collection(db, 'notifications'), {
        userId, message, relatedItemId, read: false, createdAt: serverTimestamp()
    });
}

function listenToNotifications() {
    const q = query(collection(db, 'notifications'), where('userId', '==', currentUser.uid), where('read', '==', false));
    const unsubscribe = onSnapshot(q, (snapshot) => {
        const badge = document.getElementById('notifications-badge');
        if (badge) {
            if (snapshot.size > 0) {
                badge.textContent = snapshot.size;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }
    });
    unsubscribeListeners.push(unsubscribe);
}

function showNotificationsModal() {
    const modal = document.getElementById('notifications-modal');
    modal.classList.remove('hidden');
    document.getElementById('close-notifications-modal-btn').addEventListener('click', () => modal.classList.add('hidden'), { once: true });
    
    const list = document.getElementById('notifications-list');
    const noMsg = document.getElementById('no-notifications-message');
    list.innerHTML = '';
    
    const q = query(collection(db, 'notifications'), where('userId', '==', currentUser.uid), orderBy('createdAt', 'desc'));
    const unsubscribe = onSnapshot(q, (snapshot) => {
        list.innerHTML = ''; // Limpa a lista para redesenhar
        if (snapshot.empty) {
            noMsg.classList.remove('hidden');
        } else {
            noMsg.classList.add('hidden');
            snapshot.forEach(docSnap => {
                const notif = docSnap.data();
                const notifEl = document.createElement('div');
                notifEl.className = `p-3 rounded-lg cursor-pointer ${notif.read ? 'bg-gray-100 hover:bg-gray-200' : 'bg-indigo-50 font-medium hover:bg-indigo-100'}`;
                notifEl.innerHTML = `
                    <p>${notif.message}</p>
                    <p class="text-xs text-gray-500 mt-1">${new Date(notif.createdAt?.toDate()).toLocaleString()}</p>
                `;
                list.appendChild(notifEl);
                
                notifEl.addEventListener('click', () => {
                    updateDoc(doc(db, 'notifications', docSnap.id), { read: true });
                    // Adicionar lógica de clique se necessário (ex: abrir chat)
                });
            });
        }
    });
    unsubscribeListeners.push(unsubscribe); // Adiciona para limpar depois
}

// --- Lógica Principal (Renderização de Cards, etc.) ---

function listenToMyDonations() {
    const q = query(collection(db, "clothing_items"), where("donorId", "==", currentUser.uid), orderBy("createdAt", "desc"));
    const unsubscribe = onSnapshot(q, (snapshot) => {
        const list = document.getElementById('donations-list');
        const noMsg = document.getElementById('no-donations-message');
        list.innerHTML = '';
        if (snapshot.empty) { noMsg.classList.remove('hidden'); }
        else {
            noMsg.classList.add('hidden');
            snapshot.forEach(async doc => {
                list.appendChild(await createDonationCard({ id: doc.id, ...doc.data() }));
            });
        }
    });
    unsubscribeListeners.push(unsubscribe);
}

async function createDonationCard(item) {
    const card = document.createElement('div');
    card.className = "bg-white rounded-xl shadow-md overflow-hidden flex flex-col";
    let statusBadge = '', actionButton = '';
    
    switch(item.status) {
        case 'available':
            statusBadge = `<span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Disponível</span>`;
            if (item.interestedUsers.length > 0) {
                actionButton = `<button data-item-id="${item.id}" class="raffle-btn w-full mt-4 bg-green-500 text-white font-semibold py-2 rounded-lg hover:bg-green-600 transition-all">Realizar Sorteio (${item.interestedUsers.length})</button>`;
            }
            break;
        case 'assigned':
            const recipient = await getDoc(doc(db, "users", item.assignedTo));
            const recipientName = recipient.exists() ? recipient.data().name : "Ganhador";
            statusBadge = `<span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Sorteada</span>`;
            actionButton = `
                <p class="text-sm text-center mt-2">Ganhador(a): ${recipientName}</p>
                <button data-item-id="${item.id}" data-recipient-id="${item.assignedTo}" data-recipient-name="${recipientName}" data-item-title="${item.title}" class="chat-btn w-full mt-2 bg-indigo-500 text-white font-semibold py-2 rounded-lg hover:bg-indigo-600">Ver Chat</button>
                <button data-item-id="${item.id}" data-recipient-id="${item.assignedTo}" data-recipient-name="${recipientName}" class="review-btn w-full mt-2 bg-gray-500 text-white font-semibold py-2 rounded-lg hover:bg-gray-600">Finalizar e Avaliar</button>
            `;
            break;
        case 'completed':
            statusBadge = `<span class="bg-gray-200 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded-full">Finalizada</span>`;
            actionButton = `<p class="mt-4 text-center text-sm text-green-700 font-medium">Doação concluída com sucesso!</p>`;
            break;
    }

    card.innerHTML = `<img class="w-full h-48 object-cover" src="${item.imageUrl}" alt="${item.title}"><div class="p-6 flex-grow flex flex-col"><div class="flex justify-between items-start"><h3 class="text-xl font-bold text-gray-900">${item.title}</h3>${statusBadge}</div><p class="text-gray-600 mt-2 text-sm flex-grow">${item.description}</p><div class="mt-auto">${actionButton}</div></div>`;
    
    card.querySelector('.raffle-btn')?.addEventListener('click', (e) => handleRaffle(e.target.dataset.itemId));
    card.querySelector('.chat-btn')?.addEventListener('click', (e) => openChatModal(e.target.dataset.itemId, e.target.dataset.recipientId, e.target.dataset.recipientName, e.target.dataset.itemTitle));
    card.querySelector('.review-btn')?.addEventListener('click', (e) => openReviewModal(e.target.dataset.itemId, e.target.dataset.recipientId, e.target.dataset.recipientName));
    
    return card;
}

async function handleRaffle(itemId) { 
    if (!confirm("Tem certeza que deseja realizar o sorteio? O ganhador será notificado e um chat será aberto.")) return;
    const itemDocRef = doc(db, "clothing_items", itemId);
    const itemDoc = await getDoc(itemDocRef);
    if (!itemDoc.exists()) return;
    const itemData = itemDoc.data();
    const winnerId = itemData.interestedUsers[Math.floor(Math.random() * itemData.interestedUsers.length)];
    await updateDoc(itemDocRef, { status: 'assigned', assignedTo: winnerId });
    await createNotification(winnerId, `🎉 Parabéns! Você foi sorteado(a) para receber: ${itemData.title}. Combine a entrega pelo chat.`, itemId);
    showToast("Sorteio realizado! O ganhador foi notificado.");
}
        
function listenToAvailableItems() {
    const q = query(collection(db, "clothing_items"), where("status", "==", "available"));
    const unsubscribe = onSnapshot(q, (snapshot) => {
        const gallery = document.getElementById('items-gallery'), noItemsMsg = document.getElementById('no-items-message');
        gallery.innerHTML = '';
        if (snapshot.empty) noItemsMsg.classList.remove('hidden');
        else {
            noItemsMsg.classList.add('hidden');
            snapshot.docs.forEach(doc => gallery.appendChild(createItemCard({ id: doc.id, ...doc.data() })));
        }
    });
    unsubscribeListeners.push(unsubscribe);
}

function createItemCard(item) {
    const card = document.createElement('div');
    card.className = "bg-white rounded-xl shadow-md overflow-hidden item-card flex flex-col";
    card.dataset.category = item.category; card.dataset.size = item.size;
    const alreadyInterested = item.interestedUsers.includes(currentUser.uid);
    let interestButton = alreadyInterested ? `<button class="w-full mt-4 bg-gray-300 text-gray-500 font-semibold py-2 rounded-lg cursor-not-allowed" disabled>Interesse Registrado</button>` : `<button data-item-id="${item.id}" class="interest-btn w-full mt-4 bg-indigo-500 text-white font-semibold py-2 rounded-lg hover:bg-indigo-600 transition-all">Tenho Interesse</button>`;
    card.innerHTML = `<img class="w-full h-56 object-cover" src="${item.imageUrl}" alt="${item.title}"><div class="p-6 flex-grow flex flex-col"><div class="flex justify-between items-center text-sm text-gray-500 mb-2"><span>${item.size} / ${item.category}</span><span>Doador(a): ${item.donorName.split(' ')[0]}</span></div><h3 class="text-xl font-bold text-gray-900">${item.title}</h3><p class="text-gray-600 mt-2 text-sm flex-grow">${item.description}</p><div class="mt-auto">${interestButton}</div></div>`;
    card.querySelector('.interest-btn')?.addEventListener('click', (e) => registerInterest(e.target.dataset.itemId, e.target));
    return card;
}

async function registerInterest(itemId, button) {
    button.disabled = true; button.textContent = 'Registrando...';
    try {
        await updateDoc(doc(db, "clothing_items", itemId), { interestedUsers: arrayUnion(currentUser.uid) });
        showToast("Interesse registrado com sucesso!");
        button.textContent = 'Interesse Registrado';
        button.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
        button.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
    } catch (error) { showToast("Erro ao registrar interesse.", true); button.disabled = false; button.textContent = 'Tenho Interesse'; }
}

function filterItems() {
    const category = document.getElementById('filter-category').value;
    const size = document.getElementById('filter-size').value;
    const cards = document.querySelectorAll('.item-card');
    cards.forEach(card => {
        const itemCategory = card.dataset.category;
        const itemSize = card.dataset.size;
        const categoryMatch = !category || category === itemCategory;
        const sizeMatch = !size || size === itemSize;
        if (categoryMatch && sizeMatch) {
            card.style.display = 'flex';
        } else {
            card.style.display = 'none';
        }
    });
}

function showMyRequestsModal() {
    const modal = document.getElementById('my-requests-modal');
    modal.classList.remove('hidden');
    document.getElementById('close-requests-modal-btn').addEventListener('click', () => modal.classList.add('hidden'), { once: true });
    listenToMyRequests();
}

function listenToMyRequests() {
    const q = query(collection(db, "clothing_items"), where("interestedUsers", "array-contains", currentUser.uid), orderBy("createdAt", "desc"));
    const unsubscribe = onSnapshot(q, async (snapshot) => {
        const list = document.getElementById('my-requests-list'), noRequestsMsg = document.getElementById('no-requests-message');
        list.innerHTML = '';
        if (snapshot.empty) noRequestsMsg.classList.remove('hidden');
        else {
            noRequestsMsg.classList.add('hidden');
            // Usando Promise.all para aguardar a criação de todos os cards
            const itemsHtml = await Promise.all(snapshot.docs.map(doc => createRequestItem({ id: doc.id, ...doc.data() })));
            itemsHtml.forEach(itemEl => list.appendChild(itemEl));
        }
    });
    unsubscribeListeners.push(unsubscribe);
}

async function createRequestItem(item) {
    const itemEl = document.createElement('div');
    itemEl.className = 'flex items-center gap-4 p-4 bg-gray-50 rounded-lg';
    let statusInfo = '';
    if (item.status === 'available') { statusInfo = `<span class="text-sm font-medium text-blue-600">Sorteio pendente</span>`; }
    else if (item.status === 'assigned') {
        if (item.assignedTo === currentUser.uid) {
            statusInfo = `<div class="text-right">
                            <p class="text-sm font-bold text-green-600">🎉 VOCÊ GANHOU!</p>
                            <button data-item-id="${item.id}" data-recipient-id="${currentUser.uid}" data-recipient-name="${currentUser.name}" data-item-title="${item.title}" class="chat-btn mt-1 bg-indigo-500 text-white text-xs font-semibold py-1 px-3 rounded-lg hover:bg-indigo-600">Abrir Chat</button>
                          </div>`;
        } else { statusInfo = `<span class="text-sm font-medium text-gray-600">Sorteio finalizado</span>`; }
    } else if (item.status === 'completed') {
        statusInfo = `<span class="text-sm font-medium text-green-700">Doação Concluída</span>`;
    }
    itemEl.innerHTML = `<img src="${item.imageUrl}" alt="${item.title}" class="w-16 h-16 rounded-md object-cover"><div class="flex-1"><p class="font-semibold text-gray-800">${item.title}</p><p class="text-sm text-gray-500">Doador(a): ${item.donorName.split(' ')[0]}</p></div><div>${statusInfo}</div>`;
    itemEl.querySelector('.chat-btn')?.addEventListener('click', (e) => {
        document.getElementById('my-requests-modal').classList.add('hidden'); // Fecha modal de pedidos
        openChatModal(e.target.dataset.itemId, e.target.dataset.recipientId, e.target.dataset.recipientName, e.target.dataset.itemTitle)
    });
    return itemEl;
}

// --- Funções de Inicialização e Limpeza ---
function clearSubscriptions() {
    unsubscribeListeners.forEach(unsubscribe => unsubscribe());
    unsubscribeListeners = [];
    if (currentChatUnsubscribe) {
        currentChatUnsubscribe();
        currentChatUnsubscribe = null;
    }
}

onAuthStateChanged(auth, user => {
    if (user) { 
        showDashboard(user); 
    } else { 
        currentUser = null; 
        clearSubscriptions(); 
        showLoginView(); 
    }
});



            </script>
</body>
</html>

